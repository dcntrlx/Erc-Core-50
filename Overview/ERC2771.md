# ERC2771
Created: 2020-07
Description: A standard interface for "Recipient" contracts to securely accept meta-transactions (gasless transactions) from a trusted Forwarder.

## Core Concepts

### The Problem: Gasless Transactions
To allow users to interact with a dApp without paying gas (e.g., paid by the dApp developer), a "Relayer" must send the transaction on the user's behalf.
-   **Issue**: If the Relayer calls the contract, `msg.sender` is the Relayer, not the User. The contract thinks the Relayer is the one acting.
-   **Old Solution**: Custom logic in every contract to verify signatures and unpack the "real" sender.

### The Solution: Trusted Forwarder
ERC-2771 standardizes how contracts identify the "real" sender when called by a Relayer.
1.  **Forwarder**: A contract that verifies the user's signature and nonce. If valid, it calls the destination contract.
2.  **Protocol**: The Forwarder appends the user's address to the end of the `calldata`.
3.  **Recipient**: The destination contract checks if `msg.sender` is a Trusted Forwarder. If so, it reads the last 20 bytes of `calldata` to get the user's address.

## Methods

### Discovery
```solidity
function isTrustedForwarder(address forwarder) external view returns (bool);
```
-   Returns `true` if the contract trusts this specific forwarder to relay transactions.

### Sender Extraction (Internal)
Instead of using `msg.sender` directly, the contract uses a helper (like OpenZeppelin's `_msgSender()`):
```solidity
function _msgSender() internal view returns (address) {
    if (isTrustedForwarder(msg.sender)) {
        // Extract the last 20 bytes of calldata
        return address(bytes20(msg.data[msg.data.length - 20:]));
    }
    return msg.sender;
}
```

## Implementation Details

### The Forwarder Contract
The Forwarder is responsible for:
-   Verifying the user's signature (EIP-712).
-   Checking nonces (Replay protection).
-   Paying the gas.
-   Calling the destination with `abi.encodePacked(originalData, userAddress)`.

### The Recipient Contract
The Recipient must:
-   Trust a specific Forwarder address (immutable or updatable by admin).
-   Replace all instances of `msg.sender` with `_msgSender()`.
-   Replace all instances of `msg.data` with `_msgData()` (to trim the appended address).

## Risks
1.  **Trust**: If the Forwarder is malicious (or upgraded maliciously), it can spoof *any* address. Recipients should only trust verified, immutable Forwarders.
2.  **Calldata Manipulation**: The Recipient must ensure it parses `msg.data` correctly. If it reads the appended address as part of the function arguments, logic errors can occur.
3.  **Overhead**: Minimal gas overhead for the extra calldata and the check.
