# ERC-4337: Account Abstraction
**Created:** 2021-09-29

**Description:** A standard for Account Abstraction that avoids consensus-layer changes by using a higher-layer pseudo-transaction object called `UserOperation`.

## Core Concept
Traditionally, Ethereum has two types of accounts:
1.  **EOA (Externally Owned Account):** Controlled by a private key. Can initiate transactions.
2.  **Smart Contract:** Controlled by code. Cannot initiate transactions.

**Account Abstraction (AA)** aims to blur this line, allowing Smart Contracts to initiate transactions and pay for gas. ERC-4337 achieves this **without hard forks** by creating a secondary "Alt Mempool" for intents.

## The Architecture
Instead of sending a transaction, a user sends a **UserOperation** (UserOp).

### 1. The Components
*   **UserOperation:** A structure that *looks* like a transaction (sender, to, data, nonce, signature) but is just a data object.
*   **Bundler:** A special node (like a miner) that listens for UserOps, packages them into a real Ethereum transaction, and submits them to the chain.
*   **EntryPoint:** A global singleton contract. It is the "Trust Anchor". Bundlers call this contract to execute UserOps.
*   **Paymaster (Optional):** A contract that agrees to pay gas for the user (e.g., for gasless txs or tx for which users pay with ERC-20s).
*   **Aggregator (Optional):** A helper to validate multiple signatures at once (e.g., BLS signatures).

## The Workflow
1.  **Sign:** The user signs a `UserOperation` (intent) off-chain.
2.  **Send (Alt Mempool):** The user sends this object to a dedicated **UserOp Mempool** (the "Alt Mempool"). This is a P2P network where Bundlers listen for new operations.
3.  **Bundle:** A **Bundler** picks up multiple UserOps from this Alt Mempool and groups them into a single "Bundle Transaction".
4.  **Execute:** The Bundler submits this transaction to the **EntryPoint** contract on-chain.
5.  **Verify & Run:** The EntryPoint contract:
    *   **Verification Loop:** The EntryPoint calls `validateUserOp` on the Smart Wallet.
        *   Inside this function, the wallet checks the signature (often using **ERC-1271** logic).
        *   If valid, the wallet pays the EntryPoint the required gas (pre-fund).
    *   **Execution Loop:** If valid, it executes the calls (the actual logic).

Alt Mempool doesnt have Consensus 
it is a P2P propagation network, not a blockchain.
The `UserOperation` is cryptographically signed by the user.
The signature covers all critical fields (Sender, CallData, Nonce, Gas Limits, etc.).
If a Bundler changes *anything* (e.g., swaps the destination address), the signature becomes invalid.
The EntryPoint's verification loop will reject the operation, and the Bundler will pay for the failed gas, not the user.

## Key Features
*   **Gas Abstraction:** Users can pay gas in USDC, DAI, or have it sponsored by a dApp (via Paymasters).
*   **Social Recovery:** Lose your key? Friends or guardians can recover your account.
*   **Batching:** Do 10 actions (Approve + Swap + Stake) in one atomic click.
*   **Quantum Resistance:** You can change your signature scheme (e.g., to Lamport or BLS) without changing your address.

## The "EntryPoint" (The Engine)
The EntryPoint is the heart of the system. It ensures safety:
*   **DoS Protection:** It prevents wallets from griefing bundlers (e.g., promising to pay gas and then reverting).
*   **Gas Accounting:** It calculates exactly how much gas a UserOp used and refunds the Bundler from the Wallet's (or Paymaster's) deposit.

## Summary
ERC-4337 upgrades Ethereum accounts from "Dumb Keys" to "Smart Apps". It moves the transaction validation logic from the protocol (hardcoded) to the smart contract (programmable), unlocking a Web2-like UX for Web3.
