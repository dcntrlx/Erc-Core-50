# ERC4626
Created: 2021-12

Description: Proposes standard interface for Tokenized Vaults. It standarizes how to deposit an underlying Asset to receive Shares that represent ownership of the vault and its yield. It solves the fragmentation problem where every DeFi protocol (Yearn, Aave, Compound) had different interfaces.

## Core Concepts
Shares tokens minted and burend on deposit/withdraw. When underlying asset, grow then price of share also grow accoding to the exchange rate equation.

### The Exchange Rate Equation
$$
\text{Exchange Rate} = \frac{\text{Total Assets}}{\text{Total Shares}}
$$
- **Deposit/Withdraw**: Assets and Shares grow/shrink by the same % ratio. Price stays constant.
- **Yield**: Assets grow, Shares stay same. Price goes up.

## Methods

### Asset & Metadata
1. `asset()`: Returns the address of the underlying asset.
2. `totalAssets()`: Returns total managed assets (including yield).
3. `convertToShares(assets)`: Calculates shares for a given amount of assets (Round Down).
4. `convertToAssets(shares)`: Calculates assets for a given amount of shares (Round Down).

### Deposit / Mint (Lending)
1. `deposit(assets, receiver)`
   - Input: Exact **Assets**. Output: Calculated **Shares**.
   - Mints shares to `receiver`.
2. `mint(shares, receiver)`
   - Input: Exact **Shares**. Output: Calculated **Assets**.
   - Mints `shares` to `receiver`.

### Withdraw / Redeem (Redemption)
1. `withdraw(assets, receiver, owner)`
   - Input: Exact **Assets**. Output: Calculated **Shares**.
   - Burns shares from `owner`, sends assets to `receiver`.
2. `redeem(shares, receiver, owner)`
   - Input: Exact **Shares**. Output: Calculated **Assets**.
   - Burns `shares` from `owner`, sends assets to `receiver`.

### Limits & Previews
- `maxDeposit`, `maxMint`, `maxWithdraw`, `maxRedeem`: Return the maximum allowed amount for an action.
- `previewDeposit`, `previewMint`, `previewWithdraw`, `previewRedeem`: Simulate the result of an action (including fees/slippage).

## Rounding Security
- **Minting (Deposit)**: Round **DOWN**. Prevents minting "free" shares.
- **Burning (Withdraw)**: Round **UP** (assets $\to$ shares). Ensures vault covers liabilities.

## Nuance & Risks

### Inflation Attack (The "Empty Vault" Problem)
- **Scenario**: Attacker deposits 1 wei, then donates 1M assets.
- **Result**: 1 Share = 1,000,001 Assets. Next user deposits 1M assets $\to$ gets 0 Shares (rounding down). Attacker steals funds.
- **Solutions**:
  1. **Dead Shares**: Burn first 1000 shares (Uniswap style).
  2. **Virtual Offset**: Add a "virtual" offset to the denominator (OpenZeppelin style).
     $$ \text{Shares} = \text{Assets} \times \frac{\text{Total Shares} + 10^{\text{offset}}}{\text{Total Assets} + 1} $$

### Vault vs AMM
- **Vault**: Single Asset input. Growth via Yield. Risk: Strategy Failure.
- **AMM**: Two Asset input. Growth via Fees. Risk: Impermanent Loss.
